<html>
    <head>
        <title>色々テスト</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link rel="apple-touch-icon" href="icon.ico" sizes="192x192">
        <!--<link rel="manifest" href="./manifest.json">-->
        <script>
            // 機種ごとのマニフェスト読込
            function setManifest(path) {
                const manifest = document.createElement('link');
                manifest.rel = 'manifest';
                manifest.href = path;
                document.head.appendChild(manifest);
            }
            var ua = navigator.userAgent.toLocaleLowerCase();
            if (ua.indexOf('iphone') > 0 || ua.indexOf('ipad') > 0) {
                setManifest('manifest_ios.json');
            } else {
                setManifest('manifest.json');
            }
            // サービスワーカー登録
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(function() {console.log('Service Worker Registered');
                });
            }
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
//                showInstallPromotion();
            });
        </script>
        <style>
            body {
                text-align: center;
                font-size: 40px;
                vertical-align: middle;
            }
        </style>
    </head>
    <body>
        <button id="btnReload">hogeeee</button>
        <video id="player" autoplay playsinline></video>
        <canvas id="canvas" width="300" height="200" style="display:none;"></canvas>
        <div>barcode text: <span id="rawValue"></span></div>
        <div>location: <a href="#" id="loc"></a></div>
        <button id="start">Start</button>
        <button id="stop">Stop</button>
        <script src="https://cdn.jsdelivr.net/npm/jsqr@latest/dist/jsQR.min.js"></script>

        <script>
            const video = document.getElementById('player');
            const canvas = document.getElementById('canvas');
            var info = document.getElementById('rawValue');
            const ctx = canvas.getContext('2d');
            const loc = document.getElementById('loc');

            const startBtn = document.getElementById('start');
            const stopBtn = document.getElementById('stop');
            startBtn.onclick = () => {
                const constraints = {
                    video: true,
                    audio: false,
                    video: {
                        width: 300,
                        height: 200,
                        facingMode: "environment"
                    }
                };
                navigator.mediaDevices.getUserMedia(constraints)
                .then((stream) => {
                    return new Promise((res) => {
                        video.srcObject = stream;
                        video.addEventListener('loadedmetadata', ev => res(ev));
                    });
                })
                .then(({target}) => {
                    return new Promise((res) => {
                        const loop = setInterval(() => {
                            ctx.drawImage(target, 0, 0, target.videoWidth, target.videoHeight);
                            const img = ctx.getImageData(0, 0, target.videoWidth, target.videoHeight);
                            const code = jsQR(img.data, img.width, img.height);
                            if (code) {
                                clearInterval(loop);
                                target.srcObject.getTracks()[0].stop();
                                target.srcObject = null;
                                info.textContent = code.data;
                                setLocation();
//                                res(code.data);
                            }
                        }, 100);
                    });
                })
                ;
            };
            stopBtn.onclick = () => {
                video.pause();
                const track = video.srcObject.getTracks()[0];
                track.stop();
            };
            function setLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((pos) => {
                        var lati = pos.coords.latitude;
                        var longi = pos.coords.longitude;
                        loc.textContent = lati + "/" + longi;
                        var linktag = 'https://www.google.co.jp/search?q=' + lati + ',' + longi;
                        loc.href = linktag;
                    });
                } else {
                    loc.textContent = "Geolocationが使えない";
                }
            }

            // リロード用（キャッシュクリア）
           const btnReload = document.getElementById('btnReload');
           btnReload.onclick = () => {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations()
                        .then(registrations => {
                            for (let regi of registrations) {
                                regi.unregister();
                            }
                        });
                    window.location.reload(true);
                }
           };
        </script>
    </body>
</html>
