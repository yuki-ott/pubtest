<html>
    <head>
        <title>色々テスト</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link rel="manifest" href="./manifest.json">
        <script>
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(function() {console.log('Service Worker Registered');
                })
          }
        </script>
        <style>
            body {
                text-align: center;
                font-size: 40px;
                vertical-align: middle;
            }
        </style>
    </head>
    <body>
        <button>hogeeee</button>
        <video id="player" width="300" height="200" muted></video>
        <canvas id="snapshot" width="100" height="100"></canvas>
        <div>
            barcode text: <span id="rawValue"></span>
        </div>
        <button id="start">Start</button>
        <button id="stop">Stop</button>
        <!--<script src="instascan.min.js"></script>-->
        <script src="jsQR.js"></script>
        <script>
            //navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || window.navigator.mozGetUserMedia;
            const video = document.getElementById('player');
            const canvas = document.getElementById('snapshot');
            var info = document.getElementById('rawValue');
            const ctx = canvas.getContext('2d');
            window.onload = () => {
                const consraints = {
                    audio: false,
                    video: {
                        width: 300,
                        height: 200,
                        facingMode: "environment"
                    }
                };
                navigator.mediaDevices.getUserMedia(consraints)
                .then((stream) => {
                    video.srcObject = stream;
                    vodeo.onloadedmetadata = (e) => {
                        video.play();
                    };
                });
            };

            function checkPicture() {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, canvas.width, canvas.height);
                if (code) {
                    info.textContent = code.data;
                } else {
                    setTimeout(() => {
                        checkPicture();
                    }, 300);
                }
            }


            /*
            // instascan
            var videoTag = document.getElementById('player');
            var scanner = new Instascan.Scanner({video:videoTag});
            var info = document.getElementById('rawValue');
            scanner.addListener('scan', function(value) {
                console.log(value);
                info.textContent = value;
            });

            const startBtn = document.getElementById('start');
            const stopBtn = document.getElementById('stop');
            startBtn.onclick = function() {
                Instascan.Camera.getCameras()
                    .then(function(cameras) {
                        if (cameras.length > 0) {
                            scanner.start(cameras[0]);
                        } else {
                            console.error('camera not found');
                        }
                    }).catch(function(err) {
                        // エラー処理
                    });
            };
            stopBtn.onclick = function() {
                Instascan.Camera.getCameras()
                    .then(function(cameras) {
                        if (cameras.length > 0) {
                            scanner.stop(cameras[0]);
                        } else {
                            console.error('camera not found');
                        }
                    }).catch(function(err) {

                    });
            };
            */

            /*
            const video = document.getElementById('player');
            const canvas = document.getElementById('snapshot');
            const ctx = canvas.getContext('2d');
            let videoTracks;
            let localStream = null;
            let captureTimer = null;
            const fps = 10;
            let medias = {
                video:
                {
                    width: 100,
                    height: 100,
                    facingMode: {exact: "environment"}
                },
                audio: false
            };

            const startBtn = document.getElementById('start');
            const stopBtn = document.getElementById('stop');

            startBtn.onclick = function() {
                navigator.mediaDevices.getUserMedia(medias)
                    .then(function(stream) {
                        video.srcObject = stream;
                        localStream = stream;

                        if (window.BarcodeDetector) {
                            const detector = new BarcodeDetector();
                            captureTimer = setInterval(function() {
                                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                                let scale = 1;
                                detector.detect(video).then(function(barcodes) {
                                    ctx.lineWidth = 2;
                                    ctx.strokeStyle = 'red';
                                    for (let barcode of barcodes) {
                                        ctx.beginPath();
                                        ctx.rect(
                                            Math.floor(barcode.boudingBox.x * scale),
                                            Math.floor(barcode.boudingBox.y * scale),
                                            Math.floor(barcode.boudingBox.width * scale),
                                            Math.floor(barcode.boudingBox.height * scale)
                                            );
                                        ctx.stroke();
                                        document.getElementById('rawValue')
                                            .innerHTML = convertLink(barcode.rawValue);
                                    }
                                }).catch(function(err) {console.error(err)});
                            }, 1000 / fps);
                        }
                        else {
                            console.error('BarcodeDetection is not enable');
                        }
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                    }).catch(function(err) {
                        // リアカメラがないケース
                        console.error(err);
                    });
            };
            stopBtn.onclick = function() {
                clearInterval(captureTimer);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                localStream.getTracks().forEach(function(track) {
                    track.stop();
                });
                localStream = null;
                video.srcObject = null;
                startBtn.disabled = false;
                stopBtn.disabled = true;
            };
            function convertLink(str) {
                const r = /((h?)(ttps?:\/\/[a-zA-Z0-9.\-_@:\/~?%&;=+#',()*!]+))/g; //']))/;
                const regLink = function(all, url, h, href) {
                    return '<a href="h' + href + '">' + url + '</a>';
                }
                return str.replace(r, regLink);
            };
            startBtn.click();
            */
        </script>
    </body>
</html>
